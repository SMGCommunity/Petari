#include "JSystem/JParticle/MultiEmitterCallBack.hpp"
#include "Game/Player/MarioEffect.hpp"
#include "Game/Effect/MultiEmitter.hpp"
#include "Game/Effect/ParticleEmitter.hpp"
#include "Game/LiveActor/EffectKeeper.hpp"
#include "Game/LiveActor/ModelObj.hpp"
#include "Game/Player/Mario.hpp"
#include "Game/Player/MarioActor.hpp"
#include "Game/Player/MarioSwim.hpp"
#include "Game/Util/AreaObjUtil.hpp"
#include "Game/Util/DemoUtil.hpp"
#include "Game/Util/EffectUtil.hpp"
#include "Game/Util/EventUtil.hpp"
#include "Game/Util/HashUtil.hpp"
#include "Game/Util/JointUtil.hpp"
#include "Game/Util/LiveActorUtil.hpp"
#include "Game/Util/MapUtil.hpp"
#include "Game/Util/MathUtil.hpp"
#include "Game/Util/MtxUtil.hpp"
#include "Game/Map/HitInfo.hpp"
#include "JSystem/JParticle/JPAEmitter.hpp"
#include <cstdio>
#include <cstring>

extern "C" void JPASetRMtxTVecfromMtx(const Mtx, Mtx, TVec3f*);

namespace MR {
    bool isPermitSE();
}

extern char lbl_805C6A30[];
extern char lbl_805C6A3F[];
extern char lbl_805C6A4C[];
extern char lbl_805C6A59[];
extern char lbl_805C6A67[];
extern char lbl_805C6A73[];
extern char lbl_805C6A7F[];
extern char lbl_805C6A89[];
extern char lbl_805C6A95[];
extern char lbl_805C6AA0[];
extern char lbl_805C6AA9[];
extern char lbl_805C6AB7[];
extern char lbl_805C6AC2[];
extern char lbl_805C6ACC[];
extern char lbl_805C6AD7[];
extern char lbl_805C6AE0[];
extern char lbl_805C6AE9[];
extern char lbl_805C6AFA[];
extern char lbl_805C6B10[];

struct MaterialEffectEntry {
    /* 0x00 */ const char* mName;
    /* 0x04 */ u32 mFlag;
    /* 0x08 */ const char* mEffects[7];
    /* 0x24 */ const char* mCurrent;
    /* 0x28 */ MultiEmitter* mEmitter;
};

struct SmokeEffectEntry {
    /* 0x00 */ const char* mName;
    /* 0x04 */ u32 mType;
    /* 0x08 */ f32 mScale;
    /* 0x0C */ f32 mRate;
    /* 0x10 */ u32 mFlags;
    /* 0x14 */ u16 mInterval;
    /* 0x16 */ u16 mTimer;
    /* 0x18 */ u32 mHash;
    /* 0x1C */ MultiEmitter* mEmitter;
    /* 0x20 */ u8 mMaterial;
    /* 0x21 */ u8 _21[3];
};

char lbl_806B22A0[] = "%s";
char lbl_806B22A3[] = "Ice";

MaterialEffectEntry cMaterialEffectTable[] = {
    { lbl_805C6A30, 0x00000000, { lbl_805C6A3F, lbl_805C6A4C, lbl_805C6A59, lbl_805C6A67, lbl_805C6A73, lbl_805C6A7F, lbl_805C6A89 }, nullptr, nullptr },
    { lbl_805C6A95, 0x03000000, { lbl_805C6AA0, lbl_805C6AA9, lbl_805C6AA0, lbl_805C6AA0, lbl_805C6AA0, lbl_805C6AA0, lbl_805C6AA0 }, nullptr, nullptr },
    { lbl_805C6AB7, 0x00000000, { nullptr, lbl_805C6AC2, lbl_805C6ACC, lbl_805C6AD7, lbl_805C6AE0, lbl_805C6A7F, lbl_805C6A89 }, nullptr, nullptr },
    { lbl_805C6AE9, 0x00000000, { lbl_805C6AFA, nullptr, nullptr, lbl_805C6B10, nullptr, nullptr, nullptr }, nullptr, nullptr },
    { nullptr, 0, { nullptr, nullptr, nullptr, nullptr, nullptr, nullptr, nullptr }, nullptr, nullptr }
};

char lbl_805C6C04[] = "Honey";
char lbl_805C6C0A[] = "Sand";

char lbl_805C6C64[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x92, 0x85, 0x92, 0x6E, 0x95, 0x81, 0x92, 0xCA, 0x00
};

char lbl_805C6C71[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x92, 0x85, 0x92, 0x6E, 0x91, 0xE5, 0x00
};

char lbl_805C6C7C[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x95, 0xC7, 0x83, 0x57, 0x83, 0x83, 0x83, 0x93, 0x83, 0x76, 0x00
};

char lbl_805C6C8B[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x8D, 0xBB, 0x89, 0x8C, 0x83, 0x8C, 0x83, 0x78, 0x83, 0x8B, 0x00
};

char lbl_805C6C9A[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x95, 0xC7, 0x8E, 0xE8, 0x8E, 0x43, 0x82, 0xE8, 0x00
};

char lbl_805C6CA7[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x95, 0xC7, 0x8F, 0xE3, 0x8F, 0xB8, 0x00
};

char lbl_805C6CB2[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x83, 0x58, 0x83, 0x8A, 0x83, 0x62, 0x83, 0x76, 0x8D, 0xE2, 0x00
};

char lbl_805C6CC1[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x83, 0x58, 0x83, 0x8A, 0x83, 0x62, 0x83, 0x76, 0x8B, 0xF3, 0x93, 0x5D,
    0x00
};

char lbl_805C6CD2[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x83, 0x58, 0x83, 0x8A, 0x83, 0x62, 0x83, 0x76, 0x8D, 0xE2, 0x90, 0xA7,
    0x93, 0xAE, 0x00
};

char lbl_805C6CE5[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x95, 0xC7, 0x83, 0x71, 0x83, 0x62, 0x83, 0x67, 0x92, 0x85, 0x92, 0x6E,
    0x00
};

char lbl_805C6CF6[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x83, 0x5F, 0x83, 0x81, 0x81, 0x5B, 0x83, 0x57, 0x92, 0x85, 0x92, 0x6E,
    0x00
};

char lbl_805C6D07[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x92, 0x6E, 0x8F, 0xE3, 0x83, 0x58, 0x83, 0x73, 0x83, 0x93, 0x00
};

char lbl_805C6D16[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x83, 0x75, 0x83, 0x8C, 0x81, 0x5B, 0x83, 0x4C, 0x00
};

char lbl_805C6D23[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x83, 0x6E, 0x83, 0x43, 0x83, 0x57, 0x83, 0x83, 0x83, 0x93, 0x83, 0x76,
    0x00
};

char lbl_805C6D34[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x83, 0x75, 0x83, 0x89, 0x83, 0x62, 0x83, 0x4E, 0x83, 0x7A, 0x81, 0x5B,
    0x83, 0x8B, 0x00
};

char lbl_805C6D47[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x88, 0xF8, 0x82, 0xAB, 0x96, 0xDF, 0x82, 0xB5, 0x92, 0x85, 0x92, 0x6E,
    0x00
};

char lbl_805C6D58[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x90, 0x85, 0x92, 0xEA, 0x90, 0xDA, 0x90, 0x47, 0x00
};

char lbl_805C6D65[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x92, 0xB5, 0x96, 0xF4, 0x00
};

char lbl_805C6D6E[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x82, 0xD0, 0x82, 0xB1, 0x82, 0xA4, 0x82, 0xAB, 0x89, 0x5F, 0x00
};

char lbl_805C6D7D[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x82, 0xD0, 0x82, 0xB1, 0x82, 0xA4, 0x82, 0xAB, 0x83, 0x75, 0x81, 0x5B,
    0x83, 0x58, 0x83, 0x67, 0x00, 0x00, 0x00
};

SmokeEffectEntry cSmokeTable[] = {
    { lbl_805C6C64, 0x08000000, 1.0f, 1.0f, 0x00000400, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6C71, 0x03000000, 1.5f, 1.0f, 0x00000400, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6C7C, 0x03000000, 1.0f, 1.0f, 0x00000300, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6C8B, 0x07000000, 0.65f, 1.0f, 0x00000000, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6C9A, 0x01000000, 0.35f, 1.0f, 0x02010000, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6CA7, 0x01000000, 1.0f, 1.0f, 0x00000200, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6CB2, 0x02000000, 0.35f, 1.0f, 0x00010000, 2, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6CC1, 0x00000000, 1.0f, 1.0f, 0x00000000, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6CD2, 0x02000000, 0.5f, 1.0f, 0x00000000, 2, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6CE5, 0x03000000, 1.0f, 1.0f, 0x00000400, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6CF6, 0x03000000, 1.0f, 1.0f, 0x00000400, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6D07, 0x03000000, 0.9f, 1.0f, 0x00000400, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6D16, 0x02000000, 0.65f, 1.0f, 0x00010000, 15, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6D23, 0x02000000, 0.65f, 1.0f, 0x00010000, 6, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6D34, 0x01000000, 0.65f, 1.0f, 0x03030000, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6D47, 0x03000000, 1.2f, 1.0f, 0x00000400, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6D58, 0x01000000, 6.0f, 0.5f, 0x00000400, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6D65, 0x08000000, 1.0f, 1.0f, 0x00000C00, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6D6E, 0x03000000, 0.3f, 0.2f, 0x00010000, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { lbl_805C6D7D, 0x00000000, 2.0f, 1.0f, 0x00000000, 0, 0, 0, nullptr, 0, { 0, 0, 0 } },
    { nullptr, 0, 0.0f, 0.0f, 0, 0, 0, 0, nullptr, 0, { 0, 0, 0 } }
};

char lbl_805C7088[] = "SmokeSphere";
char lbl_805C7094[] = "SmokeSphereLoop";
char lbl_805C70A4[] = "SmokeCircle";
char lbl_805C70B0[] = "SmokeCircleLoop";
char lbl_805C70C0[] = "WaterSphere";
char lbl_805C70CC[] = "WaterSphereLoop";
char lbl_805C70DC[] = "WaterCircle";
char lbl_805C70E8[] = "WaterCircleLoop";
char lbl_805C70F8[] = "FlowerCircle";
char lbl_805C7105[] = "FlowerSphereLoop";
char lbl_805C7116[] = "SandCircle";
char lbl_805C7121[] = "SandSphereLoop";
char lbl_805C7130[] = "SnowSphere";
char lbl_805C713B[] = "SnowSphereLoop";
char lbl_805C714A[] = "SnowCircle";
char lbl_805C7155[] = "SnowCircleLoop";
char lbl_805C7164[] = "SmokeSphereFollow";
char lbl_805C7176[] = "SmokeSphereFollow1Time";
char lbl_805C718D[] = "SmokeCircleFollow";
char lbl_805C719F[] = "SmokeCircleLoopFollow";
char lbl_805C71B5[] = "MudSphere";
char lbl_805C71BF[] = "MudSphereLoop";
char lbl_805C71CD[] = "MudCircleLoop";
char lbl_805C71DB[] = "HoneySphere";
char lbl_805C71E7[] = "HoneySphereLoop";

char lbl_805C71F7[] = {
    0x48, 0x6F, 0x6E, 0x65, 0x79, 0x43, 0x69, 0x72, 0x63, 0x6C, 0x65, 0x4C, 0x6F, 0x6F, 0x70, 0x00,
    0x46, 0x6F, 0x6F, 0x74, 0x52, 0x00, 0x48, 0x61, 0x6E, 0x64, 0x52, 0x00, 0x53, 0x70, 0x69, 0x6E,
    0x65, 0x31, 0x00, 0x00, 0x00
};

char lbl_805C72B0[] = {
    0x4D, 0x61, 0x72, 0x69, 0x6F, 0x00, 0x53, 0x6C, 0x69, 0x70, 0x55, 0x70, 0x00, 0x83, 0x58, 0x83,
    0x8A, 0x83, 0x62, 0x83, 0x76, 0x83, 0x41, 0x83, 0x62, 0x83, 0x76, 0x00, 0x57, 0x61, 0x6C, 0x6C,
    0x53, 0x70, 0x61, 0x72, 0x6B, 0x00, 0x95, 0xC7, 0x83, 0x58, 0x83, 0x70, 0x81, 0x5B, 0x83, 0x4E,
    0x00, 0x44, 0x61, 0x6D, 0x61, 0x67, 0x65, 0x00, 0x83, 0x5F, 0x83, 0x81, 0x81, 0x5B, 0x83, 0x57,
    0x00, 0x53, 0x74, 0x65, 0x70, 0x4F, 0x6E, 0x00, 0x82, 0xD3, 0x82, 0xDD, 0x82, 0xC2, 0x82, 0xD4,
    0x82, 0xB5, 0x00, 0x53, 0x75, 0x70, 0x65, 0x72, 0x53, 0x70, 0x69, 0x6E, 0x44, 0x72, 0x69, 0x76,
    0x65, 0x72, 0x45, 0x6E, 0x64, 0x00, 0x83, 0x58, 0x81, 0x5B, 0x83, 0x70, 0x81, 0x5B, 0x83, 0x58,
    0x83, 0x73, 0x83, 0x93, 0x83, 0x68, 0x83, 0x89, 0x83, 0x43, 0x83, 0x6F, 0x8F, 0x49, 0x97, 0xB9,
    0x00, 0x42, 0x72, 0x69, 0x6E, 0x67, 0x42, 0x75, 0x62, 0x62, 0x6C, 0x65, 0x00, 0x88, 0xF8, 0x82,
    0xAB, 0x96, 0xDF, 0x82, 0xB5, 0x96, 0x41, 0x00, 0x42, 0x72, 0x69, 0x6E, 0x67, 0x42, 0x75, 0x62,
    0x62, 0x6C, 0x65, 0x42, 0x72, 0x65, 0x61, 0x6B, 0x00, 0x88, 0xF8, 0x82, 0xAB, 0x96, 0xDF, 0x82,
    0xB5, 0x96, 0x41, 0x94, 0x6A, 0x97, 0xF4, 0x00, 0x57, 0x61, 0x74, 0x65, 0x72, 0x53, 0x70, 0x6C,
    0x61, 0x73, 0x68, 0x52, 0x69, 0x67, 0x68, 0x74, 0x00, 0x90, 0x85, 0x82, 0xCD, 0x82, 0xCB, 0x89,
    0x45, 0x00, 0x57, 0x61, 0x74, 0x65, 0x72, 0x53, 0x70, 0x6C, 0x61, 0x73, 0x68, 0x4C, 0x65, 0x66,
    0x74, 0x00, 0x90, 0x85, 0x82, 0xCD, 0x82, 0xCB, 0x8D, 0xB6, 0x00, 0x57, 0x61, 0x74, 0x65, 0x72,
    0x53, 0x70, 0x6C, 0x61, 0x73, 0x68, 0x53, 0x52, 0x69, 0x67, 0x68, 0x74, 0x00, 0x90, 0x85, 0x82,
    0xCD, 0x82, 0xCB, 0x89, 0x45, 0x8E, 0xE3, 0x00, 0x57, 0x61, 0x74, 0x65, 0x72, 0x53, 0x70, 0x6C,
    0x61, 0x73, 0x68, 0x53, 0x4C, 0x65, 0x66, 0x74, 0x00, 0x90, 0x85, 0x82, 0xCD, 0x82, 0xCB, 0x8D,
    0xB6, 0x8E, 0xE3, 0x00, 0x53, 0x70, 0x69, 0x6E, 0x4C, 0x69, 0x67, 0x68, 0x74, 0x42, 0x75, 0x72,
    0x73, 0x74, 0x00, 0x83, 0x58, 0x83, 0x73, 0x83, 0x93, 0x83, 0x89, 0x83, 0x43, 0x83, 0x67, 0x8F,
    0xC1, 0x8B, 0x8E, 0x00, 0x45, 0x6C, 0x65, 0x63, 0x74, 0x72, 0x69, 0x63, 0x44, 0x61, 0x6D, 0x61,
    0x67, 0x65, 0x00, 0x83, 0x72, 0x83, 0x8A, 0x83, 0x72, 0x83, 0x8A, 0x00, 0x46, 0x69, 0x72, 0x65,
    0x44, 0x61, 0x6D, 0x61, 0x67, 0x65, 0x53, 0x6D, 0x6F, 0x6B, 0x65, 0x00, 0x89, 0x8A, 0x83, 0x5F,
    0x83, 0x81, 0x81, 0x5B, 0x83, 0x57, 0x89, 0x8C, 0x00, 0x42, 0x6C, 0x75, 0x65, 0x46, 0x69, 0x72,
    0x65, 0x44, 0x61, 0x6D, 0x61, 0x67, 0x65, 0x53, 0x6D, 0x6F, 0x6B, 0x65, 0x00, 0x89, 0x8A, 0x83,
    0x5F, 0x83, 0x81, 0x81, 0x5B, 0x83, 0x57, 0x90, 0xC2, 0x89, 0x8C, 0x00, 0x53, 0x70, 0x69, 0x6E,
    0x4C, 0x69, 0x67, 0x68, 0x74, 0x00, 0x83, 0x58, 0x83, 0x73, 0x83, 0x93, 0x83, 0x89, 0x83, 0x43,
    0x83, 0x67, 0x00, 0x49, 0x63, 0x65, 0x4D, 0x61, 0x72, 0x69, 0x6F, 0x53, 0x70, 0x69, 0x6E, 0x4C,
    0x69, 0x67, 0x68, 0x74, 0x00, 0x83, 0x41, 0x83, 0x43, 0x83, 0x58, 0x83, 0x58, 0x83, 0x73, 0x83,
    0x93, 0x00, 0x46, 0x69, 0x72, 0x65, 0x4D, 0x61, 0x72, 0x69, 0x6F, 0x53, 0x70, 0x69, 0x6E, 0x4C,
    0x69, 0x67, 0x68, 0x74, 0x00, 0x83, 0x74, 0x83, 0x40, 0x83, 0x43, 0x83, 0x41, 0x83, 0x58, 0x83,
    0x73, 0x83, 0x93, 0x00, 0x42, 0x65, 0x65, 0x4D, 0x61, 0x72, 0x69, 0x6F, 0x53, 0x70, 0x69, 0x6E,
    0x4C, 0x69, 0x67, 0x68, 0x74, 0x00, 0x83, 0x6E, 0x83, 0x60, 0x83, 0x58, 0x83, 0x73, 0x83, 0x93,
    0x00, 0x42, 0x65, 0x65, 0x4C, 0x75, 0x69, 0x67, 0x69, 0x53, 0x70, 0x69, 0x6E, 0x4C, 0x69, 0x67,
    0x68, 0x74, 0x00, 0x83, 0x6E, 0x83, 0x60, 0x83, 0x8B, 0x83, 0x43, 0x81, 0x5B, 0x83, 0x57, 0x83,
    0x58, 0x83, 0x73, 0x83, 0x93, 0x00, 0x53, 0x77, 0x65, 0x61, 0x74, 0x00, 0x82, 0xA2, 0x82, 0xA2,
    0x8A, 0xBE, 0x00, 0x43, 0x61, 0x72, 0x72, 0x79, 0x53, 0x74, 0x61, 0x72, 0x74, 0x53, 0x68, 0x6F,
    0x72, 0x74, 0x00, 0x82, 0xD0, 0x82, 0xEB, 0x82, 0xA2, 0x83, 0x4E, 0x83, 0x43, 0x83, 0x62, 0x83,
    0x4E, 0x00, 0x41, 0x69, 0x72, 0x52, 0x65, 0x63, 0x6F, 0x76, 0x65, 0x72, 0x00, 0x8E, 0x5F, 0x91,
    0x66, 0x89, 0xF1, 0x95, 0x9C, 0x00, 0x49, 0x6E, 0x76, 0x69, 0x6E, 0x63, 0x69, 0x62, 0x6C, 0x65,
    0x00, 0x96, 0xB3, 0x93, 0x47, 0x92, 0x86, 0x00, 0x83, 0x41, 0x83, 0x43, 0x83, 0x58, 0x92, 0x86,
    0x00, 0x46, 0x69, 0x72, 0x65, 0x42, 0x61, 0x6C, 0x6C, 0x54, 0x68, 0x72, 0x6F, 0x77, 0x00, 0x83,
    0x74, 0x83, 0x40, 0x83, 0x43, 0x83, 0x41, 0x83, 0x7B, 0x81, 0x5B, 0x83, 0x8B, 0x93, 0x8A, 0x82,
    0xB0, 0x00, 0x54, 0x68, 0x72, 0x6F, 0x77, 0x00, 0x82, 0xB1, 0x82, 0xA4, 0x82, 0xE7, 0x93, 0x8A,
    0x82, 0xB0, 0x00, 0x44, 0x69, 0x65, 0x42, 0x75, 0x72, 0x79, 0x42, 0x6F, 0x64, 0x79, 0x00, 0x8D,
    0xBB, 0x96, 0x84, 0x82, 0xDC, 0x82, 0xE8, 0x91, 0xCC, 0x00, 0x44, 0x69, 0x65, 0x42, 0x75, 0x72,
    0x79, 0x48, 0x61, 0x6E, 0x64, 0x00, 0x8D, 0xBB, 0x96, 0x84, 0x82, 0xDC, 0x82, 0xE8, 0x8E, 0xE8,
    0x00, 0x44, 0x69, 0x65, 0x44, 0x65, 0x61, 0x74, 0x68, 0x4D, 0x75, 0x64, 0x42, 0x6F, 0x64, 0x79,
    0x00, 0x93, 0x44, 0x96, 0x84, 0x82, 0xDC, 0x82, 0xE8, 0x91, 0xCC, 0x00, 0x44, 0x69, 0x65, 0x44,
    0x65, 0x61, 0x74, 0x68, 0x4D, 0x75, 0x64, 0x48, 0x61, 0x6E, 0x64, 0x00, 0x93, 0x44, 0x96, 0x84,
    0x82, 0xDC, 0x82, 0xE8, 0x8E, 0xE8, 0x00, 0x53, 0x70, 0x69, 0x6E, 0x4C, 0x69, 0x67, 0x68, 0x74,
    0x43, 0x6F, 0x6E, 0x63, 0x65, 0x6E, 0x74, 0x72, 0x61, 0x74, 0x65, 0x00, 0x83, 0x58, 0x83, 0x73,
    0x83, 0x93, 0x8B, 0x96, 0x89, 0xC2, 0x00, 0x46, 0x6F, 0x6F, 0x4D, 0x61, 0x72, 0x69, 0x6F, 0x48,
    0x61, 0x6E, 0x64, 0x47, 0x6C, 0x6F, 0x77, 0x4C, 0x00, 0x83, 0x74, 0x81, 0x5B, 0x83, 0x7D, 0x83,
    0x8A, 0x83, 0x49, 0x83, 0x4F, 0x83, 0x8D, 0x81, 0x5B, 0x8D, 0xB6, 0x00, 0x46, 0x6F, 0x6F, 0x4D,
    0x61, 0x72, 0x69, 0x6F, 0x48, 0x61, 0x6E, 0x64, 0x47, 0x6C, 0x6F, 0x77, 0x52, 0x00, 0x83, 0x74,
    0x81, 0x5B, 0x83, 0x7D, 0x83, 0x8A, 0x83, 0x49, 0x83, 0x4F, 0x83, 0x8D, 0x81, 0x5B, 0x89, 0x45,
    0x00, 0x46, 0x6F, 0x6F, 0x4D, 0x61, 0x72, 0x69, 0x6F, 0x42, 0x72, 0x61, 0x6B, 0x65, 0x4C, 0x61,
    0x6D, 0x70, 0x4C, 0x00, 0x83, 0x74, 0x81, 0x5B, 0x83, 0x7D, 0x83, 0x8A, 0x83, 0x49, 0x83, 0x75,
    0x83, 0x8C, 0x81, 0x5B, 0x83, 0x4C, 0x8D, 0xB6, 0x00, 0x46, 0x6F, 0x6F, 0x4D, 0x61, 0x72, 0x69,
    0x6F, 0x42, 0x72, 0x61, 0x6B, 0x65, 0x4C, 0x61, 0x6D, 0x70, 0x52, 0x00, 0x83, 0x74, 0x81, 0x5B,
    0x83, 0x7D, 0x83, 0x8A, 0x83, 0x49, 0x83, 0x75, 0x83, 0x8C, 0x81, 0x5B, 0x83, 0x4C, 0x89, 0x45,
    0x00, 0x46, 0x6F, 0x6F, 0x4D, 0x61, 0x72, 0x69, 0x6F, 0x45, 0x6E, 0x64, 0x4C, 0x00, 0x83, 0x74,
    0x81, 0x5B, 0x83, 0x7D, 0x83, 0x8A, 0x83, 0x49, 0x89, 0xF0, 0x8F, 0x9C, 0x8D, 0xB6, 0x00, 0x46,
    0x6F, 0x6F, 0x4D, 0x61, 0x72, 0x69, 0x6F, 0x45, 0x6E, 0x64, 0x52, 0x00, 0x83, 0x74, 0x81, 0x5B,
    0x83, 0x7D, 0x83, 0x8A, 0x83, 0x49, 0x89, 0xF0, 0x8F, 0x9C, 0x89, 0x45, 0x00, 0x57, 0x61, 0x6C,
    0x6C, 0x48, 0x69, 0x74, 0x00, 0x95, 0xC7, 0x83, 0x71, 0x83, 0x62, 0x83, 0x67, 0x00, 0x42, 0x61,
    0x72, 0x72, 0x69, 0x65, 0x72, 0x42, 0x6F, 0x75, 0x6E, 0x64, 0x00, 0x8C, 0x8B, 0x8A, 0x45, 0x83,
    0x71, 0x83, 0x62, 0x83, 0x67, 0x00, 0x57, 0x61, 0x74, 0x65, 0x72, 0x42, 0x6F, 0x75, 0x6E, 0x64,
    0x00, 0x90, 0x85, 0x95, 0xC7, 0x83, 0x71, 0x83, 0x62, 0x83, 0x67, 0x00, 0x49, 0x63, 0x65, 0x57,
    0x61, 0x6C, 0x6C, 0x4A, 0x75, 0x6D, 0x70, 0x00, 0x95, 0x58, 0x95, 0xC7, 0x83, 0x57, 0x83, 0x83,
    0x83, 0x93, 0x83, 0x76, 0x00, 0x43, 0x65, 0x69, 0x6C, 0x69, 0x6E, 0x67, 0x43, 0x72, 0x61, 0x73,
    0x68, 0x00, 0x93, 0x56, 0x88, 0xE4, 0x83, 0x71, 0x83, 0x62, 0x83, 0x67, 0x00, 0x43, 0x6F, 0x69,
    0x6E, 0x00, 0x83, 0x52, 0x83, 0x43, 0x83, 0x93, 0x00, 0x50, 0x75, 0x6E, 0x63, 0x68, 0x48, 0x69,
    0x74, 0x00, 0x83, 0x70, 0x83, 0x93, 0x83, 0x60, 0x83, 0x71, 0x83, 0x62, 0x83, 0x67, 0x00, 0x57,
    0x61, 0x74, 0x65, 0x72, 0x52, 0x69, 0x70, 0x70, 0x6C, 0x65, 0x00, 0x90, 0x85, 0x94, 0x67, 0x96,
    0xE4, 0x00, 0x53, 0x77, 0x69, 0x6D, 0x57, 0x61, 0x69, 0x74, 0x52, 0x69, 0x70, 0x70, 0x6C, 0x65,
    0x00, 0x90, 0x85, 0x96, 0xCA, 0x83, 0x45, 0x83, 0x47, 0x83, 0x43, 0x83, 0x67, 0x94, 0x67, 0x96,
    0xE4, 0x00, 0x53, 0x77, 0x69, 0x6D, 0x53, 0x70, 0x69, 0x6E, 0x4C, 0x69, 0x67, 0x68, 0x74, 0x00,
    0x90, 0x85, 0x89, 0x6A, 0x83, 0x58, 0x83, 0x73, 0x83, 0x93, 0x00, 0x44, 0x69, 0x76, 0x65, 0x42,
    0x75, 0x62, 0x62, 0x6C, 0x65, 0x00, 0x90, 0x85, 0x96, 0xCA, 0x82, 0x79, 0x92, 0xBE, 0x8D, 0x7E,
    0x00, 0x57, 0x61, 0x74, 0x65, 0x72, 0x43, 0x6F, 0x6C, 0x75, 0x6D, 0x6E, 0x53, 0x00, 0x90, 0x85,
    0x96, 0xCA, 0x83, 0x57, 0x83, 0x83, 0x83, 0x93, 0x83, 0x76, 0x90, 0x85, 0x92, 0x8C, 0x00, 0x53,
    0x75, 0x72, 0x66, 0x61, 0x63, 0x65, 0x57, 0x61, 0x76, 0x65, 0x00, 0x90, 0x85, 0x96, 0xCA, 0x89,
    0x6A, 0x82, 0xAC, 0x00, 0x42, 0x6F, 0x64, 0x79, 0x42, 0x75, 0x62, 0x62, 0x6C, 0x65, 0x00, 0x90,
    0x85, 0x92, 0x86, 0x90, 0x67, 0x91, 0xCC, 0x96, 0x41, 0x00, 0x4D, 0x6F, 0x75, 0x74, 0x68, 0x42,
    0x75, 0x62, 0x62, 0x6C, 0x65, 0x00, 0x90, 0x85, 0x92, 0x86, 0x8C, 0xFB, 0x96, 0x41, 0x00, 0x53,
    0x65, 0x61, 0x53, 0x6D, 0x6F, 0x6B, 0x65, 0x00, 0x90, 0x85, 0x92, 0xEA, 0x90, 0xDA, 0x90, 0x47,
    0x00, 0x4D, 0x65, 0x74, 0x61, 0x6D, 0x6F, 0x72, 0x70, 0x68, 0x6F, 0x73, 0x69, 0x73, 0x00, 0x95,
    0xCF, 0x90, 0x67, 0x00, 0x4D, 0x65, 0x74, 0x61, 0x6D, 0x6F, 0x72, 0x70, 0x68, 0x6F, 0x73, 0x69,
    0x73, 0x45, 0x6E, 0x64, 0x00, 0x95, 0xCF, 0x90, 0x67, 0x89, 0xF0, 0x8F, 0x9C, 0x00, 0x42, 0x65,
    0x65, 0x46, 0x6C, 0x6F, 0x77, 0x65, 0x72, 0x50, 0x6F, 0x6C, 0x6C, 0x65, 0x6E, 0x00, 0x83, 0x6E,
    0x83, 0x60, 0x89, 0xD4, 0x82, 0xAD, 0x82, 0xC1, 0x82, 0xC2, 0x82, 0xAB, 0x00, 0x53, 0x6B, 0x61,
    0x74, 0x65, 0x4C, 0x00, 0x83, 0x58, 0x83, 0x50, 0x81, 0x5B, 0x83, 0x67, 0x8D, 0xB6, 0x00, 0x53,
    0x6B, 0x61, 0x74, 0x65, 0x52, 0x00, 0x83, 0x58, 0x83, 0x50, 0x81, 0x5B, 0x83, 0x67, 0x89, 0x45,
    0x00, 0x49, 0x63, 0x65, 0x4A, 0x75, 0x6D, 0x70, 0x4C, 0x61, 0x6E, 0x64, 0x00, 0x83, 0x58, 0x83,
    0x50, 0x81, 0x5B, 0x83, 0x67, 0x92, 0x85, 0x92, 0x6E, 0x00
};

char lbl_805C78BA[] = {
    0x46, 0x6C, 0x6F, 0x77, 0x65, 0x72, 0x53, 0x70, 0x69, 0x6E, 0x00, 0x42, 0x6C, 0x75, 0x72, 0x00,
    0x83, 0x8F, 0x81, 0x5B, 0x83, 0x76, 0x83, 0x7C, 0x83, 0x62, 0x83, 0x68, 0x83, 0x75, 0x83, 0x89,
    0x81, 0x5B, 0x00, 0x53, 0x70, 0x69, 0x6E, 0x52, 0x69, 0x6E, 0x67, 0x00
};

char lbl_805C78E6[] = {
    0x83, 0x58, 0x83, 0x73, 0x83, 0x93, 0x83, 0x8A, 0x83, 0x93, 0x83, 0x4F, 0x00, 0x56, 0x61, 0x6E,
    0x69, 0x73, 0x68, 0x00, 0x83, 0x75, 0x83, 0x89, 0x83, 0x62, 0x83, 0x4E, 0x83, 0x7A, 0x81, 0x5B,
    0x83, 0x8B, 0x8F, 0xC1, 0x96, 0xC5, 0x00, 0x90, 0xE1, 0x89, 0x8C, 0x83, 0x8C, 0x83, 0x78, 0x83,
    0x8B, 0x00, 0x43, 0x72, 0x65, 0x73, 0x74, 0x47, 0x65, 0x74, 0x46, 0x6C, 0x79, 0x43, 0x00, 0x83,
    0x58, 0x83, 0x43, 0x83, 0x93, 0x83, 0x4F, 0x83, 0x74, 0x83, 0x89, 0x83, 0x43, 0x00, 0x43, 0x6F,
    0x6D, 0x6D, 0x6F, 0x6E, 0x50, 0x68, 0x6F, 0x74, 0x6F, 0x6E, 0x44, 0x75, 0x73, 0x74, 0x43, 0x69,
    0x72, 0x63, 0x6C, 0x65, 0x00, 0x89, 0x46, 0x92, 0x88, 0x97, 0x56, 0x89, 0x6A, 0x00, 0x4D, 0x61,
    0x72, 0x69, 0x6F, 0x53, 0x70, 0x61, 0x63, 0x65, 0x44, 0x75, 0x73, 0x74, 0x00, 0x83, 0x57, 0x83,
    0x83, 0x83, 0x93, 0x83, 0x76, 0x83, 0x74, 0x83, 0x46, 0x83, 0x41, 0x83, 0x8A, 0x81, 0x5B, 0x00,
    0x42, 0x83, 0x5F, 0x83, 0x62, 0x83, 0x56, 0x83, 0x85, 0x00, 0x4D, 0x69, 0x6E, 0x69, 0x50, 0x61,
    0x6E, 0x64, 0x61, 0x53, 0x70, 0x69, 0x6E, 0x4C, 0x6F, 0x6F, 0x70, 0x4C, 0x65, 0x67, 0x00, 0x83,
    0x43, 0x83, 0x93, 0x83, 0x5F, 0x83, 0x43, 0x83, 0x8C, 0x83, 0x4E, 0x83, 0x67, 0x83, 0x65, 0x83,
    0x58, 0x83, 0x67, 0x00, 0x49, 0x6E, 0x64, 0x54, 0x65, 0x73, 0x74, 0x00, 0x83, 0x89, 0x83, 0x50,
    0x83, 0x62, 0x83, 0x67, 0x8F, 0xC1, 0x8B, 0x8E, 0x00, 0x54, 0x65, 0x73, 0x74, 0x4D, 0x61, 0x72,
    0x69, 0x6F, 0x42, 0x61, 0x6F, 0x62, 0x61, 0x62, 0x6F, 0x6F, 0x50, 0x6F, 0x77, 0x65, 0x72, 0x44,
    0x6F, 0x77, 0x6E, 0x00, 0x83, 0x60, 0x83, 0x83, 0x81, 0x5B, 0x83, 0x57, 0x8A, 0xAE, 0x97, 0xB9,
    0x00, 0x54, 0x6F, 0x72, 0x6E, 0x61, 0x64, 0x6F, 0x43, 0x68, 0x61, 0x72, 0x67, 0x65, 0x45, 0x6E,
    0x64, 0x00, 0x83, 0x60, 0x83, 0x83, 0x81, 0x5B, 0x83, 0x57, 0x92, 0x86, 0x00, 0x54, 0x6F, 0x72,
    0x6E, 0x61, 0x64, 0x6F, 0x43, 0x68, 0x61, 0x72, 0x67, 0x65, 0x00, 0x83, 0x60, 0x83, 0x83, 0x81,
    0x5B, 0x83, 0x57, 0x90, 0xD8, 0x82, 0xEA, 0x00, 0x41, 0x70, 0x70, 0x6C, 0x65, 0x48, 0x69, 0x74,
    0x00, 0x4C, 0x61, 0x6E, 0x64, 0x52, 0x75, 0x62, 0x62, 0x65, 0x72, 0x00, 0x93, 0xC1, 0x8E, 0xEA,
    0x92, 0x85, 0x92, 0x6E, 0x00, 0x44, 0x69, 0x65, 0x44, 0x61, 0x72, 0x6B, 0x4D, 0x61, 0x74, 0x74,
    0x65, 0x72, 0x00, 0x83, 0x5F, 0x81, 0x5B, 0x83, 0x4E, 0x83, 0x7D, 0x83, 0x5E, 0x81, 0x5B, 0x8E,
    0x80, 0x96, 0x53, 0x00, 0x48, 0x6F, 0x70, 0x70, 0x65, 0x72, 0x4D, 0x61, 0x72, 0x69, 0x6F, 0x48,
    0x69, 0x70, 0x44, 0x72, 0x6F, 0x70, 0x42, 0x6C, 0x75, 0x72, 0x00, 0x83, 0x7A, 0x83, 0x62, 0x83,
    0x70, 0x81, 0x5B, 0x90, 0x4B, 0x97, 0x8E, 0x00, 0x48, 0x6F, 0x70, 0x70, 0x65, 0x72, 0x4C, 0x75,
    0x69, 0x67, 0x69, 0x48, 0x69, 0x70, 0x44, 0x72, 0x6F, 0x70, 0x42, 0x6C, 0x75, 0x72, 0x00, 0x83,
    0x7A, 0x83, 0x62, 0x83, 0x70, 0x81, 0x5B, 0x90, 0x4B, 0x97, 0x8E, 0x83, 0x8B, 0x83, 0x43, 0x81,
    0x5B, 0x83, 0x57, 0x00, 0x48, 0x69, 0x70, 0x44, 0x72, 0x6F, 0x70, 0x42, 0x6C, 0x75, 0x72, 0x00,
    0x90, 0x4B, 0x97, 0x8E, 0x00, 0x48, 0x69, 0x70, 0x44, 0x72, 0x6F, 0x70, 0x42, 0x6C, 0x75, 0x72,
    0x4C, 0x75, 0x69, 0x67, 0x69, 0x00, 0x90, 0x4B, 0x97, 0x8E, 0x83, 0x8B, 0x83, 0x43, 0x81, 0x5B,
    0x83, 0x57, 0x00, 0x47, 0x65, 0x74, 0x41, 0x67, 0x61, 0x69, 0x6E, 0x00, 0x83, 0x41, 0x83, 0x43,
    0x83, 0x65, 0x83, 0x80, 0x8D, 0xC4, 0x83, 0x51, 0x83, 0x62, 0x83, 0x67, 0x00, 0x83, 0x70, 0x83,
    0x93, 0x83, 0x60, 0x83, 0x75, 0x83, 0x89, 0x81, 0x5B, 0x8D, 0xB6, 0x00, 0x4D, 0x61, 0x72, 0x69,
    0x6F, 0x50, 0x75, 0x6E, 0x63, 0x68, 0x4C, 0x42, 0x6C, 0x75, 0x72, 0x00, 0x83, 0x70, 0x83, 0x93,
    0x83, 0x60, 0x83, 0x75, 0x83, 0x89, 0x81, 0x5B, 0x89, 0x45, 0x00, 0x4D, 0x61, 0x72, 0x69, 0x6F,
    0x50, 0x75, 0x6E, 0x63, 0x68, 0x52, 0x42, 0x6C, 0x75, 0x72, 0x00
};

char lbl_805C7B31[] = "WaterColumn";

char lbl_805C7B4C[] = {
    0x8B, 0xA4, 0x92, 0xCA, 0x8D, 0xBB, 0x89, 0x8C, 0x83, 0x8C, 0x83, 0x78, 0x83, 0x8B, 0x00, 0x8B,
    0xA4, 0x92, 0xCA, 0x83, 0x58, 0x83, 0x8A, 0x83, 0x62, 0x83, 0x76, 0x8D, 0xE2, 0x00, 0x83, 0x89,
    0x83, 0x43, 0x83, 0x74, 0x8C, 0x78, 0x8D, 0x90, 0x00, 0x91, 0xAE, 0x90, 0xAB, 0x83, 0x6E, 0x83,
    0x60, 0x95, 0x97, 0x00
};

char lbl_805C7B80[] = {
    0x91, 0xAE, 0x90, 0xAB, 0x83, 0x58, 0x83, 0x73, 0x83, 0x93, 0x00
};

char lbl_805C7B8B[] = "EffectCylinder";
char lbl_805C7B9A[] = "SmokeEffectColorArea";

char lbl_805C7CD8[] = {
    0x8B, 0xF3, 0x92, 0x86, 0x82, 0xD0, 0x82, 0xCB, 0x82, 0xE8, 0x00
};

char lbl_805C7CE3[] = {
    0x92, 0x86, 0x83, 0x5F, 0x83, 0x81, 0x81, 0x5B, 0x83, 0x57, 0x00, 0x92, 0x86, 0x83, 0x5F, 0x83,
    0x81, 0x81, 0x5B, 0x83, 0x57, 0x8B, 0xF3, 0x92, 0x86, 0x00, 0x92, 0x86, 0x83, 0x5F, 0x83, 0x81,
    0x81, 0x5B, 0x83, 0x57, 0x92, 0x85, 0x92, 0x6E, 0x00, 0x8B, 0xA4, 0x92, 0xCA, 0x83, 0x5F, 0x83,
    0x81, 0x81, 0x5B, 0x83, 0x57, 0x92, 0x85, 0x92, 0x6E, 0x00, 0x90, 0x81, 0x82, 0xC1, 0x94, 0xF2,
    0x82, 0xD1, 0x93, 0x7C, 0x82, 0xEA, 0x00, 0x83, 0x5F, 0x83, 0x81, 0x81, 0x5B, 0x83, 0x57, 0x00,
    0x83, 0x5F, 0x83, 0x81, 0x81, 0x5B, 0x83, 0x57, 0x92, 0x85, 0x92, 0x6E, 0x00, 0x8A, 0xEE, 0x96,
    0x7B, 0x00, 0x00, 0x00, 0x00
};

namespace {

void addMarioEffectAtJoint(LiveActor* pActor, const char* pEffectName, const char* pJointName, const char* pGroupName) {
    MtxPtr mtx = pJointName ? MR::getJointMtx(pActor, pJointName) : pActor->getBaseMtx();
    pActor->mEffectKeeper->registerEffect(pEffectName, mtx, &pActor->mScale, pGroupName, pJointName);
}

}  // namespace

void MarioEffect::execute(JPABaseEmitter* pEmitter) {
    s32 idx = 0;
    for (s32 i = 0; i < 256; i++) {
        if (_54[i].mEmitter == pEmitter) {
            break;
        }
        idx++;
    }
    updateFollowMtx(&_54[idx]);
}

JPABaseEmitter* MarioEffect::addRequest(const char* pEffectName, MtxPtr pMtx) {
    MovingFollowMtx* target = nullptr;
    u32 maxAge = 0;

    for (s32 i = 0; i < 256; i++) {
        if (!_54[i].mEmitter) {
            target = &_54[i];
            break;
        }

        if (!target || _54[i]._0 > maxAge) {
            maxAge = _54[i]._0;
            target = &_54[i];
        }
    }

    MultiEmitter* emitter = MR::emitEffectWithEmitterCallBack(mActor, pEffectName, this);

    ParticleEmitter* particle = emitter->getParticleEmitter(0);
    if (!particle) {
        return nullptr;
    }

    JPABaseEmitter* baseEmitter = emitter->getParticleEmitter(0)->mEmitter;

    for (s32 i = 0; i < 256; i++) {
        if (target != &_54[i] && _54[i].mEmitter == baseEmitter) {
            _54[i].mEmitter = nullptr;
        }
    }

    target->_0 = 0;
    target->_64 = pMtx;
    target->mEmitter = baseEmitter;
    return baseEmitter;
}

void MarioEffect::updateFollowMtx(MovingFollowMtx* pFollow) {
    JPABaseEmitter* emitter = pFollow->mEmitter;
    if ((emitter->mFlag & 0x8) && (emitter->_D0 + emitter->_DC) == 0) {
        pFollow->mEmitter = nullptr;
        return;
    }

    if (pFollow->_0 == 0) {
        TMtx34f temp;
        PSMTXCopy(_24.toMtxPtr(), temp.toMtxPtr());

        const TVec3f& rTrans = getTrans();
        MR::setMtxTrans(temp.toMtxPtr(), rTrans.x, rTrans.y, rTrans.z);

        if (!pFollow->_64) {
            TPos3f* baseMtx = getPlayer()->getMoveBaseMtx();
            if (baseMtx) {
                pFollow->_64 = baseMtx->toMtxPtr();
            }
        }

        if (!pFollow->_64) {
            return;
        }

        Mtx inv;
        PSMTXInverse(pFollow->_64, inv);
        PSMTXConcat(inv, temp.toMtxPtr(), pFollow->_4.toMtxPtr());
        PSMTXCopy(temp.toMtxPtr(), pFollow->_34.toMtxPtr());
    } else {
        PSMTXConcat(pFollow->_64, pFollow->_4.toMtxPtr(), pFollow->_34.toMtxPtr());
    }

    JPASetRMtxTVecfromMtx(pFollow->_34.toMtxPtr(), emitter->_68, &emitter->_A4);

    pFollow->_0++;
    if (pFollow->_0 == 2) {
        emitter->mFlag = (emitter->mFlag & ~0x2) | 0x1;
        emitter->_24 = 1;
    }
}

void MarioActor::initMaterialEffect() {
    s32 count = 0;

    for (MaterialEffectEntry* entry = cMaterialEffectTable; entry->mName; ++entry) {
        for (s32 i = 0; i < 7; i++) {
            const char* effectName = entry->mEffects[i];
            if (!effectName) {
                continue;
            }

            if (!MR::isRegisteredEffect(this, effectName)) {
                mEffectKeeper->registerEffectWithoutSRT(effectName, nullptr);
            } else {
                MR::setEffectHostSRT(this, effectName, nullptr, nullptr, nullptr);
            }
        }

        entry->mCurrent = nullptr;
        entry->mEmitter = nullptr;
        count++;
    }

    HashSortTable* table = new HashSortTable(count);
    _BA4 = reinterpret_cast<u32>(table);

    for (MaterialEffectEntry* entry = cMaterialEffectTable; entry->mName; ++entry) {
        table->add(entry->mName, reinterpret_cast<u32>(entry), false);
    }
    table->sort();
}

s32 MarioActor::getFloorMaterialIndex(u32 flags) const {
    if (mMarioEffect->_10 == 0) {
        return 2;
    }

    if (_3A8 != 0) {
        return 1;
    }

    u16 floor = mMario->_960;
    if ((floor == 0x0D || floor == 0x1E) && !mMario->isCurrentFloorSand()) {
        floor = mMario->_962;
    }

    if (mMario->isStatusActive(1)) {
        if (mMario->mMovementStates_LOW_WORD & 0x00800000) {
            floor = mMario->_964[0];
        } else if (mMario->mMovementStates_LOW_WORD & 0x00000040) {
            floor = mMario->_964[1];
        } else if (mMario->mMovementStates_LOW_WORD & 0x00000020) {
            floor = mMario->_964[2];
        }
    }

    if ((mMario->mDrawStates_WORD & 0x00002000) || (mMario->mDrawStates_WORD & 0x00001000)) {
        floor = 0x17;
    }

    if ((flags & 0x2) && (mMario->mDrawStates_WORD & 0x00000004)) {
        floor = 0x17;
    }

    if (mMario->_2D0 != 0.0f) {
        floor = 0x1A;
    }

    if (mMario->isPlayerModeBee() && MR::isWallCodeNoAction(mMario->mGroundPolygon)) {
        return -1;
    }

    s32 materialIndex = 0;

    switch (floor) {
    case 0x0D:
    case 0x1E:
        materialIndex = 3;
        break;
    case 0x0E:
    case 0x21:
        return -1;
    case 0x14:
    case 0x15:
    case 0x16:
    case 0x17:
        materialIndex = 1;
        break;
    case 0x1A:
        materialIndex = 4;
        break;
    case 0x1B:
    case 0x1C:
        if (strcmp(MR::getSoundCodeString(mMario->_45C), lbl_805C6C0A) == 0) {
            materialIndex = 3;
        }
        break;
    case 0x20:
        materialIndex = 5;
        if (strcmp(MR::getSoundCodeString(mMario->_45C), lbl_805C6C04) == 0) {
            materialIndex = 6;
        }
        break;
    default:
        break;
    }

    if ((mMario->mDrawStates_WORD & 0x00002000) || (mMario->mDrawStates_WORD & 0x00001000)) {
        materialIndex = 1;
    }

    if (!(mMario->mMovementStates_LOW_WORD & 0x40000000) && mMario->mSwim->_1B2 != 0 &&
        mMario->mSwim->_1B8 < 0.0f) {
        materialIndex = 1;
    }

    return materialIndex;
}

MultiEmitter* MarioActor::playMaterialEffect(const char* pName) {
    HashSortTable* table = reinterpret_cast<HashSortTable*>(_BA4);
    u32 value = 0;

    table->search(pName, &value);

    MaterialEffectEntry* entry = reinterpret_cast<MaterialEffectEntry*>(value);
    u8 flag = entry->mFlag >> 24;
    s32 materialIndex = getFloorMaterialIndex(flag);
    if (materialIndex == -1) {
        return nullptr;
    }

    const char* effectName = entry->mEffects[materialIndex];
    if (!effectName) {
        return nullptr;
    }

    if (flag == 1 && entry->mCurrent == effectName) {
        return entry->mEmitter;
    }

    MultiEmitter* emitter = MR::emitEffect(this, effectName);

    if (entry->mCurrent && entry->mCurrent != effectName) {
        MR::deleteEffect(this, entry->mCurrent);
    }

    entry->mCurrent = effectName;
    entry->mEmitter = emitter;

    if (emitter) {
        if (mMarioEffect->_18) {
            emitter->setGlobalPrmColor(mMarioEffect->_1C.r, mMarioEffect->_1C.g, mMarioEffect->_1C.b, -1);
            emitter->setGlobalEnvColor(mMarioEffect->_20.r, mMarioEffect->_20.g, mMarioEffect->_20.b, -1);
        } else {
            emitter->setGlobalPrmColor(0xFF, 0xFF, 0xFF, -1);
            emitter->setGlobalEnvColor(0xFF, 0xFF, 0xFF, -1);
        }
    }

    return emitter;
}

void MarioActor::stopMaterialEffect(const char* pName) {
    HashSortTable* table = reinterpret_cast<HashSortTable*>(_BA4);
    u32 value = 0;

    table->search(pName, &value);

    MaterialEffectEntry* entry = reinterpret_cast<MaterialEffectEntry*>(value);
    if (entry->mCurrent) {
        MR::deleteEffect(this, entry->mCurrent);
        entry->mCurrent = nullptr;
        entry->mEmitter = nullptr;
    }
}

void MarioActor::initCommonEffect() {
    _B9C = 0;
    _B9E = 0;
    _BA0 = reinterpret_cast<u32>(new SmokeEffectEntry*[8]);

    const char* const smokeEffects[] = { lbl_805C7088, lbl_805C7094, lbl_805C70A4, lbl_805C70B0 };
    const char* const waterEffects[] = { lbl_805C70C0, lbl_805C70CC, lbl_805C70DC, lbl_805C70E8 };
    const char* const flowerEffects[] = { lbl_805C70F8, lbl_805C7105, lbl_805C70F8, lbl_805C7105 };
    const char* const sandEffects[] = { lbl_805C7116, lbl_805C7121, lbl_805C7116, lbl_805C7121 };
    const char* const snowEffects[] = { lbl_805C7130, lbl_805C713B, lbl_805C714A, lbl_805C7155 };
    const char* const smokeFollowEffects[] = { lbl_805C7164, lbl_805C7176, lbl_805C718D, lbl_805C719F };
    const char* const mudEffects[] = { lbl_805C71B5, lbl_805C71BF, lbl_805C6A7F, lbl_805C71CD };
    const char* const honeyEffects[] = { lbl_805C71DB, lbl_805C71E7, lbl_805C6A89, lbl_805C71F7 };
    const char* base = lbl_805C6A30;

    for (SmokeEffectEntry* entry = cSmokeTable; entry->mName; ++entry) {
        u8 type = entry->mType >> 24;
        u8 variant = 0;
        bool useFollow = false;

        switch (type) {
        case 0:
            variant = 0;
            break;
        case 1:
        case 2:
            variant = 1;
            break;
        case 3:
            variant = 2;
            break;
        case 4:
        case 5:
            variant = 3;
            break;
        case 6:
            variant = 0;
            useFollow = true;
            break;
        case 7:
            variant = 1;
            useFollow = true;
            break;
        case 8:
            variant = 2;
            useFollow = true;
            break;
        case 9:
            variant = 3;
            useFollow = true;
            break;
        default:
            variant = 0;
            break;
        }

        for (s32 materialIndex = 0; materialIndex < 7; materialIndex++) {
            char name[64];
            sprintf(name, lbl_806B22A0, entry->mName);
            char* alias = name + materialIndex;

            u8 flag2 = (entry->mFlags >> 8) & 0xFF;
            if ((flag2 & 0x8) && materialIndex != 1) {
                continue;
            }

            const char* effectName = nullptr;
            switch (materialIndex) {
            case 0:
                effectName = useFollow ? smokeFollowEffects[variant] : smokeEffects[variant];
                break;
            case 1:
                effectName = waterEffects[variant];
                break;
            case 2:
                effectName = flowerEffects[variant];
                break;
            case 3:
                effectName = sandEffects[variant];
                break;
            case 4:
                effectName = snowEffects[variant];
                break;
            case 5:
                effectName = mudEffects[variant];
                break;
            case 6:
                effectName = honeyEffects[variant];
                break;
            default:
                break;
            }

            if (flag2 != 0) {
                mEffectKeeper->registerEffectWithoutSRT(effectName, alias);
            } else {
                u8 flag0 = entry->mFlags >> 24;
                switch (flag0) {
                case 0:
                    mEffectKeeper->registerEffectWithoutSRT(effectName, alias);
                    MR::setEffectHostSRT(this, alias, &mPosition, &mRotation, nullptr);
                    break;
                case 1:
                    addMarioEffectAtJoint(this, effectName, base + 0x7D7, alias);
                    break;
                case 2:
                    addMarioEffectAtJoint(this, effectName, base + 0x7DD, alias);
                    break;
                case 3:
                    addMarioEffectAtJoint(this, effectName, base + 0x7E3, alias);
                    break;
                }
            }

            u8 flag1 = (entry->mFlags >> 16) & 0xFF;
            if (flag1 & 0x1) {
                MR::getEffect(this, alias)->forceFollowOn();
            }
            if (flag1 & 0x2) {
                MR::getEffect(this, alias)->forceScaleOn();
            }
        }

        entry->mTimer = 0;
        if (type == 2 || type == 5) {
            SmokeEffectEntry** entries = reinterpret_cast<SmokeEffectEntry**>(_BA0);
            entries[_B9E] = entry;
            _B9E++;
        } else {
            entry->mInterval = 0;
        }

        entry->mHash = MR::getHashCode(entry->mName);
        entry->mEmitter = nullptr;
        entry->mMaterial = 0;
        _B9C++;
    }
}

MultiEmitter* MarioActor::playCommonEffect(const char* pName) {
    if (mPlayerMode == 3) {
        return nullptr;
    }

    u32 hash = MR::getHashCode(pName);
    SmokeEffectEntry* entry = nullptr;

    for (u16 i = 0; i < _B9C; i++) {
        SmokeEffectEntry* cur = &cSmokeTable[i];
        if (cur->mHash == hash) {
            entry = cur;
            break;
        }
    }

    if (!entry) {
        return nullptr;
    }

    s32 materialIndex = getFloorMaterialIndex(0);
    if (materialIndex == -1) {
        return nullptr;
    }

    u8 flag2 = (entry->mFlags >> 8) & 0xFF;
    if ((flag2 & 0x8) && materialIndex != 1) {
        return nullptr;
    }

    u8 type = entry->mType >> 24;
    u8 hostFlag = (entry->mFlags >> 16) & 0xFF;
    MultiEmitter* emitter = nullptr;

    if (type == 1 || type == 2 || type == 4 || type == 5) {
        emitter = entry->mEmitter;
    } else if (type == 7 || type == 9) {
        if (materialIndex != 0) {
            emitter = entry->mEmitter;
        }
    }

    if (emitter && entry->mMaterial != materialIndex) {
        emitter->deleteEmitter();
        emitter = nullptr;
    }

    const char* groupName = pName + materialIndex;

    if (!emitter) {
        bool needsFollow = false;
        bool needsSRT = false;
        const Triangle* polygon = nullptr;

        if (materialIndex == 0 && type >= 6) {
            needsSRT = true;
            polygon = mMario->getGroundPolygon();
            if (polygon && !MR::isSameMtx(polygon->getBaseMtx()->toMtxPtr(), polygon->getPrevBaseMtx()->toMtxPtr())) {
                needsFollow = true;
            }
        }

        if (needsFollow) {
            JPABaseEmitter* baseEmitter = mMarioEffect->addRequest(groupName, polygon->getBaseMtx()->toMtxPtr());
            if (baseEmitter) {
                TVec3f scale(entry->mScale, entry->mScale, entry->mScale);
                baseEmitter->_98 = scale;
                baseEmitter->mGlobalScale.x = scale.x;
                baseEmitter->mGlobalScale.y = scale.y;
            }
        } else {
            if (needsSRT) {
                const TVec3f* pos = (hostFlag & 0x1) ? &mPosition : nullptr;
                const TVec3f* rot = (hostFlag & 0x4) ? &mRotation : nullptr;
                const TVec3f* scale = (hostFlag & 0x2) ? &mScale : nullptr;
                MR::setEffectHostSRT(this, groupName, pos, rot, scale);
            }

            emitter = MR::emitEffect(this, groupName);
        }
    }

    if (emitter && !(hostFlag & 0x2)) {
        emitter->setGlobalScale(entry->mScale, -1);
    }
    if (emitter) {
        emitter->setRate(entry->mRate, -1);
    }

    TVec3f zero(0.0f, 0.0f, 0.0f);
    TPos3f mtx;
    TVec3f rot;

    if (flag2 & 0x1) {
        const TVec3f& rDir = mMario->getWallNorm();
        MR::makeMtxUpNoSupportPos(&mtx, rDir, zero);
        MR::makeRTFromMtxPtr(nullptr, &rot, mtx.toMtxPtr(), true);
        if (emitter) {
            emitter->setGlobalRotationDegree(rot, -1);
            emitter->setGlobalTranslation(mPosition, -1);
        }
    } else {
        const TVec3f& rDir = mMario->_368;
        MR::makeMtxUpNoSupportPos(&mtx, rDir, zero);
        MR::makeRTFromMtxPtr(nullptr, &rot, mtx.toMtxPtr(), true);
        PSMTXCopy(mtx.toMtxPtr(), mMarioEffect->_24.toMtxPtr());
        if (emitter) {
            emitter->setGlobalRotationDegree(rot, -1);
            emitter->setGlobalTranslation(mPosition, -1);
        }
    }

    if ((flag2 & 0x2) && emitter) {
        emitter->setGlobalTranslation(mMario->_4E8, -1);
    }

    if (entry->mInterval != 0) {
        entry->mTimer = entry->mInterval;
    }

    if (type == 1 || type == 2 || type == 4 || type == 5) {
        entry->mEmitter = emitter;
        entry->mMaterial = static_cast<u8>(materialIndex);
    } else if (type == 7 || type == 9) {
        if (materialIndex != 0) {
            entry->mEmitter = emitter;
        }
        entry->mMaterial = static_cast<u8>(materialIndex);
    }

    if (emitter) {
        if (mMarioEffect->_18) {
            emitter->setGlobalPrmColor(mMarioEffect->_1C.r, mMarioEffect->_1C.g, mMarioEffect->_1C.b, -1);
            emitter->setGlobalEnvColor(mMarioEffect->_20.r, mMarioEffect->_20.g, mMarioEffect->_20.b, -1);
        } else {
            emitter->setGlobalPrmColor(0xFF, 0xFF, 0xFF, -1);
            emitter->setGlobalEnvColor(0xFF, 0xFF, 0xFF, -1);
        }

        if (materialIndex == 1) {
            emitter->setDrawOrder(3);
        }
    }

    return emitter;
}

void MarioActor::stopCommonEffect(const char* pName) {
    u32 hash = MR::getHashCode(pName);

    for (u16 i = 0; i < _B9C; i++) {
        SmokeEffectEntry* entry = &cSmokeTable[i];
        if (entry->mHash == hash) {
            if (entry->mEmitter) {
                entry->mEmitter->deleteEmitter();
                entry->mEmitter = nullptr;
            }
        }
    }
}

MultiEmitter* MarioActor::playEffect(const char* pName) {
    if (_482 || _483) {
        return nullptr;
    }

    if (isCommonEffect(pName)) {
        return playCommonEffect(pName);
    }

    if (isMaterialEffect(pName)) {
        return playMaterialEffect(pName);
    }

    return MR::emitEffect(this, pName);
}

void MarioActor::playEffectTrans(const char* pName, const TVec3f& rTrans) {
    MultiEmitter* emitter = playEffect(pName);
    if (emitter) {
        emitter->setGlobalTranslation(rTrans, -1);
    }
}

void MarioActor::playEffectRT(const char* pName, const TVec3f& rDir, const TVec3f& rTrans) {
    if (MR::isNearZero(rDir, 0.001f)) {
        return;
    }

    TVec3f zero(0.0f, 0.0f, 0.0f);
    TPos3f mtx;
    MR::makeMtxUpNoSupportPos(&mtx, rDir, zero);

    TVec3f rot;
    MR::makeRTFromMtxPtr(nullptr, &rot, mtx.toMtxPtr(), true);

    MultiEmitter* emitter = playEffect(pName);
    if (emitter) {
        emitter->forceFollowOff();
        emitter->setGlobalTranslation(rTrans, -1);
        emitter->setGlobalRotationDegree(rot, -1);
    }
}

void MarioActor::playEffectRTZ(const char* pName, const TVec3f& rDir, const TVec3f& rTrans) {
    if (MR::isNearZero(rDir, 0.001f)) {
        return;
    }

    TVec3f zero(0.0f, 0.0f, 0.0f);
    TPos3f mtx;
    MR::makeMtxUpNoSupportPos(&mtx, rDir, zero);

    TVec3f rot;
    MR::makeRTFromMtxPtr(nullptr, &rot, mtx.toMtxPtr(), true);

    MultiEmitter* emitter = playEffect(pName);
    if (emitter) {
        emitter->forceFollowOff();
        emitter->setGlobalTranslation(rTrans, -1);
        emitter->setGlobalRotationDegree(rot, -1);
    }
}

void MarioActor::playEffectRTW(const char* pName, const TVec3f& rDir, const TVec3f& rTrans) {
    if (MR::isNearZero(rDir, 0.001f)) {
        return;
    }

    TVec3f zero(0.0f, 0.0f, 0.0f);
    TPos3f mtx;
    MR::makeMtxUpNoSupportPos(&mtx, rDir, zero);

    TVec3f rot;
    MR::makeRTFromMtxPtr(nullptr, &rot, mtx.toMtxPtr(), true);

    _BB8 = rot;
    _BAC = rTrans;
    playEffect(pName);
}

void MarioActor::playEffectSRT(const char* pName, f32 scale, const TVec3f& rDir, const TVec3f& rTrans) {
    if (MR::isNearZero(rDir, 0.001f)) {
        return;
    }

    TVec3f zero(0.0f, 0.0f, 0.0f);
    TPos3f mtx;
    MR::makeMtxUpNoSupportPos(&mtx, rDir, zero);

    TVec3f rot;
    MR::makeRTFromMtxPtr(nullptr, &rot, mtx.toMtxPtr(), true);

    MultiEmitter* emitter = playEffect(pName);
    if (emitter) {
        emitter->setGlobalScale(scale, -1);
    }
    if (emitter) {
        emitter->setGlobalTranslation(rTrans, -1);
    }
    if (emitter) {
        emitter->setGlobalRotationDegree(rot, -1);
    }
}

void MarioActor::stopEffect(const char* pName) {
    if (isCommonEffect(pName)) {
        stopCommonEffect(pName);
        return;
    }

    if (isMaterialEffect(pName)) {
        stopMaterialEffect(pName);
        return;
    }

    MR::deleteEffect(this, pName);
}

void MarioActor::stopEffectForce(const char* pName) {
    if (isCommonEffect(pName)) {
        stopCommonEffect(pName);
        return;
    }

    if (isMaterialEffect(pName)) {
        stopMaterialEffect(pName);
        return;
    }

    MR::forceDeleteEffect(this, pName);
}

void MarioActor::updateEffect() {
    Mario* mario = mMario;
    const char* base = lbl_805C6A30;
    s32 flagA = 0;
    s32 flagB = 0;
    s32 flagC = 0;

    if (mario->mMovementStates_LOW_WORD & 0x08000000) {
        flagA = 1;
    }
    if ((mario->mMovementStates_LOW_WORD & 0x00010000) && (mario->mMovementStates_LOW_WORD & 0x40000000)) {
        flagA = 1;
    }
    if ((mario->mMovementStates_LOW_WORD & 0x40000000) && mario->_3F4 > 0.001f) {
        flagA = 1;
    }
    if (mario->isStatusActive(0x14)) {
        flagA = 1;
    }

    if ((mario->mMovementStates_HIGH_WORD & 0x00000800) || (mario->mMovementStates_HIGH_WORD & 0x00000400)) {
        if (mario->_278 > 0.001f) {
            flagA = 1;
        }
    }

    if (flagA) {
        flagB = 1;
        flagA = 0;
    }

    if (_3C0 || mPlayerMode == 1 || mario->isStatusActive(6) || mario->isStatusActive(0x12) || _934) {
        flagA = 0;
        flagB = 0;
        flagC = 0;
    }

    if (flagA) {
        playEffect(base + 0x111C);
    } else if (_B98 & 0x80000000) {
        stopEffect(base + 0x111C);
    }

    if (flagB) {
        if (!(_B98 & 0x40000000)) {
            playEffect(base + 0xEDD);
        }
    } else if (_B98 & 0x40000000) {
        stopEffect(base + 0xEDD);
    }

    _B98 = (_B98 & 0x1FFFFFFF) | (flagA ? 0x80000000 : 0) | (flagB ? 0x40000000 : 0) | (flagC ? 0x20000000 : 0);

    flagA = 0;
    if ((mario->mMovementStates_HIGH_WORD & 0x10000000) && !(mario->mMovementStates_LOW_WORD & 0x00000080) &&
        (mario->mMovementStates_LOW_WORD & 0x40000000)) {
        flagA = 1;
    }

    if (flagA) {
        playEffect(base + 0x112B);
    } else if (_B98 & 0x10000000) {
        stopEffect(base + 0x112B);
    }

    _B98 = (_B98 & 0xEFFFFFFF) | (flagA ? 0x10000000 : 0);

    if ((mHealth <= 1 || mWaterLife <= 1) && !MR::isDemoActive() && !MR::isPowerStarGetDemoActive() &&
        !MR::isGalaxyDarkCometAppearInCurrentStage() && MR::isPermitSE() && isEnableNerveChange()) {
        playSound(base + 0x113A, -1);
    }

    bool nearZero = MR::isNearZero(_240, 0.001f);
    if (!nearZero) {
        if (_B98 & 0x08000000) {
            playEffect(base + 0xF1B);
        }
    } else if (!(_B98 & 0x08000000)) {
        stopEffect(base + 0xF1B);
    }

    _B98 = (_B98 & 0xF7FFFFFF) | (nearZero ? 0x08000000 : 0);

    if (!isJumping() && _934 == 0) {
        MR::deleteEffect(this, base + 0xF33);
    }

    mMarioEffect->doCubeEffect();

    flagC = 0;
    if (mario->mMovementStates_LOW_WORD & 0x80000000) {
        if (mPlayerMode == 4 && mario->checkLvlA() && mario->_402 != 0 && ((_37C & 3) == 0)) {
            if (mario->mVerticalSpeed < 100.0f) {
                flagC = 1;
            } else if (mario->mSwim->_1B2 != 0 && mario->mSwim->_1B8 < 100.0f) {
                flagC = 1;
            }
        }
    }

    if (flagC) {
        playEffectRT(base + 0x1145, mario->_368, mario->mShadowPos);
    } else if (_B98 & 0x04000000) {
        stopEffect(base + 0x1145);
    }

    _B98 = (_B98 & 0xFBFFFFFF) | (flagC ? 0x04000000 : 0);

    for (u16 i = 0; i < _B9E; i++) {
        SmokeEffectEntry** entries = reinterpret_cast<SmokeEffectEntry**>(_BA0);
        SmokeEffectEntry* entry = entries[i];
        if (entry->mTimer != 0) {
            entry->mTimer--;
            if (entry->mTimer == 0) {
                stopEffect(entry->mName);
            }
        }
    }
}

void MarioActor::initEffect() {
    const char* base = lbl_805C6A30;
    _B98 = 0;
    initEffectKeeper(0xB8, base + 0x880, true);
    initCommonEffect();
    initMaterialEffect();

    MR::setEffectName(this, base + 0x886, base + 0x88D);
    MR::setEffectName(this, base + 0x89C, base + 0x8A6);
    MR::setEffectName(this, base + 0x8B1, base + 0x8B8);
    MR::setEffectName(this, base + 0x8C1, base + 0x8C8);
    MR::setEffectName(this, base + 0x8D3, base + 0x8E6);
    MR::setEffectName(this, base + 0x901, base + 0x90D);
    MR::setEffectName(this, base + 0x918, base + 0x929);
    MR::setEffectName(this, base + 0x938, base + 0x949);
    MR::setEffectName(this, base + 0x952, base + 0x962);
    MR::setEffectName(this, base + 0x96B, base + 0x97D);
    MR::setEffectName(this, base + 0x988, base + 0x999);
    MR::setEffectName(this, base + 0x9A4, base + 0x9B3);
    MR::setEffectName(this, base + 0x9C4, base + 0x9D3);
    MR::setEffectName(this, base + 0x9DC, base + 0x9EC);
    MR::setEffectName(this, base + 0x9F9, base + 0xA0D);
    MR::setEffectName(this, base + 0xA1C, base + 0xA26);
    MR::setEffectName(this, base + 0xA33, base + 0xA45);
    MR::setEffectName(this, base + 0xA52, base + 0xA65);
    MR::setEffectName(this, base + 0xA74, base + 0xA86);
    MR::setEffectName(this, base + 0xA91, base + 0xAA3);
    MR::setEffectName(this, base + 0xAB6, base + 0xABC);
    MR::setEffectName(this, base + 0xAC3, base + 0xAD3);
    MR::setEffectName(this, base + 0xAE2, base + 0xAED);
    MR::setEffectName(this, base + 0xAF6, base + 0xB01);
    MR::setEffectHostSRT(this, base + 0xB01, &mPosition, nullptr, nullptr);
    MR::setEffectName(this, lbl_806B22A3, base + 0xB08);
    MR::setEffectHostSRT(this, base + 0xB08, &mPosition, nullptr, nullptr);
    MR::setEffectName(this, base + 0xB11, base + 0xB1F);
    MR::setEffectName(this, base + 0xB32, base + 0xB38);
    MR::setEffectName(this, base + 0xB43, base + 0xB4F);
    MR::setEffectName(this, base + 0xB5A, base + 0xB66);
    MR::setEffectName(this, base + 0xB71, base + 0xB81);
    MR::setEffectName(this, base + 0xB8C, base + 0xB9C);
    MR::setEffectName(this, base + 0xBA7, base + 0xBBC);
    MR::setEffectName(this, base + 0xBC7, base + 0xBD9);
    MR::setEffectName(this, base + 0xBEC, base + 0xBFE);
    MR::setEffectName(this, base + 0xC11, base + 0xC24);
    MR::setEffectName(this, base + 0xC39, base + 0xC4C);
    MR::setEffectName(this, base + 0xC61, base + 0xC6E);
    MR::setEffectName(this, base + 0xC7F, base + 0xC8C);
    MR::setEffectName(this, base + 0xC9D, base + 0xCA5);
    MR::setEffectName(this, base + 0xCAE, base + 0xCBB);
    MR::setEffectName(this, base + 0xCC6, base + 0xCD1);
    MR::setEffectName(this, base + 0xCDC, base + 0xCE8);
    MR::setEffectHostSRT(this, base + 0xCE8, nullptr, nullptr, nullptr);
    MR::setEffectName(this, base + 0xCF5, base + 0xD02);
    MR::setEffectName(this, base + 0xD0D, base + 0xD12);
    MR::setEffectName(this, base + 0xD19, base + 0xD22);
    MR::setEffectName(this, base + 0xD2F, base + 0xD3B);
    MR::setEffectName(this, base + 0xD42, base + 0xD51);
    MR::setEffectHostSRT(this, base + 0xD51, &_BAC, &_BB8, nullptr);
    MR::setEffectName(this, base + 0xD62, base + 0xD70);
    MR::setEffectName(this, base + 0xD7B, base + 0xD86);
    MR::addEffect(this, base + 0xD91);
    MR::setEffectName(this, base + 0xD91, base + 0xD9E);
    MR::setEffectName(this, base + 0xDAF, base + 0xDBB);
    MR::setEffectHostSRT(this, base + 0xDBB, &_BAC, &_BB8, nullptr);
    MR::setEffectName(this, base + 0xDC4, base + 0xDCF);
    MR::setEffectName(this, base + 0xDDA, base + 0xDE6);
    MR::setEffectName(this, base + 0xDEF, base + 0xDF8);
    MR::setEffectName(this, base + 0xE01, base + 0xE0F);
    MR::setEffectName(this, base + 0xE14, base + 0xE25);
    MR::setEffectName(this, base + 0xE2E, base + 0xE3E);
    MR::setEffectHostSRT(this, base + 0xE3E, nullptr, nullptr, nullptr);
    MR::setEffectName(this, base + 0xE4D, base + 0xE54);
    MR::setEffectName(this, base + 0xE5F, base + 0xE66);
    MR::setEffectName(this, base + 0xE71, base + 0xE7D);

    MR::setEffectHostSRT(this, base + 0xD02, nullptr, nullptr, nullptr);
    MR::setEffectHostSRT(this, base + 0xCA5, nullptr, nullptr, nullptr);
    MR::setEffectHostSRT(this, base + 0xD22, nullptr, nullptr, nullptr);
    MR::setEffectHostSRT(this, base + 0xE8A, nullptr, nullptr, nullptr);
    MR::setEffectHostSRT(this, base + 0xD3B, nullptr, nullptr, nullptr);
    MR::setEffectHostSRT(this, base + 0xCBB, nullptr, nullptr, nullptr);
    MR::setEffectHostSRT(this, base + 0xCD1, nullptr, nullptr, nullptr);

    MR::setEffectName(this, base + 0xE95, base + 0xE9A);
    MR::setEffectName(this, base + 0xEAD, base + 0xEB6);
    MR::setEffectName(this, base + 0xEC3, base + 0xECA);

    mEffectKeeper->registerEffect(base + 0xEE8, _D1C.toMtxPtr(), base + 0xEDD, nullptr);
    mEffectKeeper->registerEffect(base + 0xF04, &mPosition, &mRotation, &mScale, base + 0xEF5);
    mEffectKeeper->registerEffect(base + 0xF24, &mPosition, &mRotation, &mScale, base + 0xF1B);
    mEffectKeeper->registerEffect(base + 0xEE8, &mPosition, &mRotation, &mScale, base + 0xF33);
    mEffectKeeper->registerEffect(base + 0xF50, &mPosition, &mRotation, &mScale, base + 0xF46);
    mEffectKeeper->registerEffect(base + 0xF7A, &mPosition, &mRotation, &mScale, base + 0xF65);
    mEffectKeeper->registerEffect(base + 0xF8F, _DAC.toMtxPtr(), base + 0xF82, nullptr);
    mEffectKeeper->registerEffect(base + 0xFB7, &mPosition, &mRotation, &mScale, base + 0xFAA);
    mEffectKeeper->registerEffect(base + 0xFD3, &mPosition, &mRotation, &mScale, base + 0xFC8);
    mEffectKeeper->registerEffect(base + 0xFEE, &mPosition, &mRotation, &mScale, base + 0xFE1);

    MR::setEffectName(this, base + 0xFF7, base + 0x1002);
    MR::setEffectName(this, base + 0x100B, base + 0x1019);
    MR::setEffectName(this, base + 0x102A, base + 0x1041);
    MR::setEffectName(this, base + 0x104E, base + 0x1065);
    MR::setEffectName(this, base + 0x107A, base + 0x1086);
    MR::setEffectName(this, base + 0x108B, base + 0x109C);
    MR::setEffectName(this, base + 0x10A9, base + 0x10B2);

    mEffectKeeper->registerEffect(base + 0x10D2, &mPosition, &mRotation, &mScale, base + 0x10C3);
    MR::getEffect(this, base + 0x10C3)->forceFollowOn();
    mEffectKeeper->registerEffect(base + 0x10F1, &mPosition, &mRotation, &mScale, base + 0x10E2);
    MR::getEffect(this, base + 0x10E2)->forceFollowOn();

    mEffectKeeper->finalizeSort();

    ModelObj* obj = new ModelObj(base + 0x1101, base + 0x1101, nullptr, -2, -2, -2, false);
    _BA8 = reinterpret_cast<u32>(obj);
    obj->kill();
}

void MarioActor::emitEffectWaterColumn(const TVec3f& rDir, const TVec3f& rTrans) {
    if (MR::isNearZero(rDir, 0.001f)) {
        return;
    }

    ModelObj* obj = reinterpret_cast<ModelObj*>(_BA8);
    obj->appear();
    MR::startBck(obj, lbl_805C7B31, nullptr);
    MR::startBrk(obj, lbl_805C7B31);

    TVec3f zero(0.0f, 0.0f, 0.0f);
    TPos3f mtx;
    MR::makeMtxUpNoSupportPos(&mtx, rDir, zero);

    TVec3f rot;
    MR::makeRTFromMtxPtr(nullptr, &rot, mtx.toMtxPtr(), true);

    obj->mPosition = rTrans;
    obj->mRotation = rot;
    obj->calcAnim();

    MR::emitEffect(obj, lbl_805C7B31);

    static Mario::Task sEffectCheckTask = reinterpret_cast<Mario::Task>(&Mario::taskOnEffectCheck);
    mMario->pushTask(sEffectCheckTask, 2);
}

bool MarioActor::isCommonEffect(const char* pName) const {
    return static_cast<u8>(pName[0]) == 0x8B && static_cast<u8>(pName[1]) == 0xA4;
}

bool MarioActor::isMaterialEffect(const char* pName) const {
    return static_cast<u8>(pName[0]) == 0x91 && static_cast<u8>(pName[1]) == 0xAE;
}

MarioEffect::MarioEffect(MarioActor* pActor) : MarioModule(pActor) {
    _1C.mColor = 0xFFFFFFFFu;
    _20.mColor = 0xFFFFFFFFu;

    register MovingFollowMtx* follow = _54;
    register MovingFollowMtx* end = _54 + 0x100;
    register u32 zero = 0;
    do {
        PSMTXIdentity(follow->_4.toMtxPtr());
        PSMTXIdentity(follow->_34.toMtxPtr());
        follow->_64 = reinterpret_cast<MtxPtr>(zero);
        follow->mEmitter = reinterpret_cast<JPABaseEmitter*>(zero);
        follow->_0 = zero;
        ++follow;
    } while (follow < end);

    _C = -1;
    _10 = -1;
    _14 = -1;
    _18 = 0;
    _1C.set(0, 0, 0, 0);
    _20.set(0, 0, 0, 0);
    PSMTXIdentity(_24.toMtxPtr());
}

void MarioEffect::playSwingEffect() {
    if (_C == 1 && _10 == 0) {
        playEffectTrans(lbl_805C78BA, getShadowPos());
    }

    Mario* mario = getPlayer();
    playEffectRT(lbl_805C7B80, mario->_368, getTrans());
}

void MarioEffect::doCubeEffect() {
    Mario* mario = getPlayer();
    if (mario->mMovementStates_LOW_WORD & 0x00000200) {
        return;
    }

    _C = -1;
    _10 = -1;

    AreaObj* area = MR::getAreaObj(lbl_805C7B8B, mActor->mPosition);
    if (area) {
        _C = MR::getAreaObjArg(area, 0);
        _10 = MR::getAreaObjArg(area, 1);
    } else {
        _14 = -1;
    }

    AreaObj* colorArea = MR::getAreaObj(lbl_805C7B9A, mActor->mPosition);
    if (colorArea) {
        _1C.set(MR::getAreaObjArg(colorArea, 0), MR::getAreaObjArg(colorArea, 1), MR::getAreaObjArg(colorArea, 2), 0);
        _20.set(MR::getAreaObjArg(colorArea, 3), MR::getAreaObjArg(colorArea, 4), MR::getAreaObjArg(colorArea, 5), 0);
        _18 = 1;
    } else {
        _18 = 0;
    }

    if (mario->_10_LOW_WORD & 0x40000000) {
        playSwingEffect();
        mario->_10_LOW_WORD &= ~0x40000000;
    }
}

bool Mario::taskOnEffectCheck(u32 flags) {
    if (flags & 0x2) {
        return mActor->checkEffectWaterColumn();
    }

    return true;
}

bool MarioActor::checkEffectWaterColumn() {
    ModelObj* obj = reinterpret_cast<ModelObj*>(_BA8);
    if (MR::isBckStopped(obj)) {
        obj->kill();
        return false;
    }

    return true;
}

void MarioActor::stopSpinTicoEffect(bool force) {
    _948 = 0;
    _94C = 0;
    _94E = 0;
    _946 = 0;

    if (force) {
        stopEffectForce(lbl_805C78E6);
    } else {
        stopEffect(lbl_805C78E6);
    }
}

MarioEffect::~MarioEffect() {
}

void MultiEmitter::setGlobalScale(f32 scale, s32 a2) {
    TVec3f scaleVec(scale, scale, scale);
    setGlobalScale(scaleVec, a2);
}
